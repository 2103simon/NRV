<!doctype html>
<html class="no-js" lang="en">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../../genindex.html" /><link rel="search" title="Search" href="../../../search.html" />

    <!-- Generated with Sphinx 6.2.1 and Furo 2023.05.20 -->
        <title>nrv.nmod.fascicles - NeuRon Virtualizer (NRV) 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo.css?digest=e6660623a769aa55fea372102b9bf3151b292993" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css" />
    
    


<style>
  body {
    --color-code-background: #f0f0f0;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #232629;
  --color-code-foreground: #cccccc;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #232629;
  --color-code-foreground: #cccccc;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../../index.html"><div class="brand">NeuRon Virtualizer (NRV) 1.0.0 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../../index.html">
  
  
  <span class="sidebar-brand-text">NeuRon Virtualizer (NRV) 1.0.0 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction.html">Introduction to NRV</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../scientific.html">Scientific foundations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">Examples</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../modules.html">nrv</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of nrv</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../nrv.html">Complete API</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Complete API</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../nrv.backend.html">nrv.backend package</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../nrv.fmod.html">nrv.fmod package</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../nrv.nmod.html">nrv.nmod package</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../nrv.optim.html">nrv.optim package</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../nrv.utils.html">nrv.utils package</a></li>
</ul>
</li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <h1>Source code for nrv.nmod.fascicles</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">NRV-fascicles</span>
<span class="sd">Authors: Florian Kolbl / Roland Giraud / Louis Regnacq / Thomas Couppey</span>
<span class="sd">(c) ETIS - University Cergy-Pontoise - CNRS</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">faulthandler</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">spatial</span>

<span class="c1"># other NRV2 librairies</span>
<span class="kn">from</span> <span class="nn">.axons</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.unmyelinated</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.myelinated</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.thin_myelinated</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.fascicle_generator</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">from</span> <span class="nn">..utils.cell.CL_postprocessing</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">from</span> <span class="nn">..fmod.extracellular</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">..fmod.recording</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">from</span> <span class="nn">..backend.file_handler</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">..backend.MCore</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">..backend.log_interface</span> <span class="kn">import</span> <span class="n">rise_error</span><span class="p">,</span> <span class="n">rise_warning</span><span class="p">,</span> <span class="n">pass_info</span>
<span class="kn">from</span> <span class="nn">..backend.NRV_Class</span> <span class="kn">import</span> <span class="n">NRV_class</span><span class="p">,</span> <span class="n">load_any</span>

<span class="c1"># verbosity level</span>
<span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># Parallel computing options</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">MCH</span><span class="o">.</span><span class="n">is_alone</span><span class="p">():</span>
    <span class="n">fg_verbose</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">MCH</span><span class="o">.</span><span class="n">do_master_only_work</span><span class="p">():</span>
        <span class="n">fg_verbose</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># enable faulthandler to ease &#39;segmentation faults&#39; debug</span>
<span class="n">faulthandler</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>

<span class="n">OTF_PP_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;NRVPATH&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/_misc/OTF_PP/&#39;</span>
<span class="n">OTF_PP_library</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">OTF_PP_path</span><span class="p">)</span>

<span class="c1">#####################</span>
<span class="c1">## Fasscicle class ##</span>
<span class="c1">#####################</span>

<div class="viewcode-block" id="is_fascicle"><a class="viewcode-back" href="../../../nrv.nmod.html#nrv.nmod.fascicles.is_fascicle">[docs]</a><span class="k">def</span> <span class="nf">is_fascicle</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    check if an object is a fascicle, return True if yes, else False</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    result : object</span>
<span class="sd">        object to test</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        True it the type is a fascicle object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">fascicle</span><span class="p">)</span></div>

<div class="viewcode-block" id="fascicle"><a class="viewcode-back" href="../../../nrv.nmod.html#nrv.nmod.fascicles.fascicle">[docs]</a><span class="k">class</span> <span class="nc">fascicle</span><span class="p">(</span><span class="n">NRV_class</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for Fascicle, defined as a group of axons near one to the other in the same Perineurium Sheath. All axons are independant of each other, no ephaptic coupling.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">Nseg_per_sec</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">freq_min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>\
        <span class="n">mesh_shape</span><span class="o">=</span><span class="s1">&#39;plateau_sigmoid&#39;</span><span class="p">,</span> <span class="n">alpha_max</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">d_lambda</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ID</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=-</span><span class="mi">40</span><span class="p">,</span>\
        <span class="n">Adelta_limit</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Instrantation of a Fascicle</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dt              : float</span>
<span class="sd">            simulation time stem for Neuron (ms), by default 1us</span>
<span class="sd">        Nseg_per_sec    : float</span>
<span class="sd">            number of segment per section in Neuron. If set to 0, the number of segment per section is calculated with the d-lambda rule</span>
<span class="sd">        freq            : float</span>
<span class="sd">            frequency of the d-lambda rule (Hz), by default 100Hz</span>
<span class="sd">        freq_min        : float</span>
<span class="sd">            minimum frequency for the d-lambda rule when meshing is irregular, 0 for regular meshing</span>
<span class="sd">        v_init          : float</span>
<span class="sd">            initial value for the membrane voltage (mV), specify None for automatic model choice of v_init</span>
<span class="sd">        T               : float</span>
<span class="sd">            temperature (C), specify None for automatic model choice of temperature</span>
<span class="sd">        ID              : int</span>
<span class="sd">            axon ID, by default set to 0</span>
<span class="sd">        threshold       : int</span>
<span class="sd">            membrane voltage threshold for spike detection (mV), by default -40mV</span>
<span class="sd">        Adelta_limit    : float</span>
<span class="sd">            limit diameter between A-delta models (thin myelinated) and myelinated models for axons</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s2">&quot;fascicle&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ID</span> <span class="o">=</span> <span class="n">ID</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">D</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># geometric properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_grav_center</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_grav_center</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N_vertices</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_vertices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_vertices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">A</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># axonal content</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axons_type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axons_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axons_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NoR_relative_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="c1"># Axons objects default parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">=</span> <span class="n">freq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freq_min</span> <span class="o">=</span> <span class="n">freq_min</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh_shape</span> <span class="o">=</span> <span class="n">mesh_shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_max</span> <span class="o">=</span> <span class="n">alpha_max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_lambda</span> <span class="o">=</span> <span class="n">d_lambda</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">=</span> <span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Adelta_limit</span> <span class="o">=</span> <span class="n">Adelta_limit</span>
        <span class="c1"># extra-cellular stimulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_stim</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">footprints</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_footprinted</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">myelinated_nseg_per_sec</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unmyelinated_nseg</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="c1"># intra-cellular stimulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N_intra</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_position</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_t_start</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_duration</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_amplitude</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_ON</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">## recording mechanism</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">record</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recorder</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_simulated</span> <span class="o">=</span> <span class="kc">False</span>


    <span class="c1">## save/load methods</span>
<div class="viewcode-block" id="fascicle.save"><a class="viewcode-back" href="../../../nrv.nmod.html#nrv.nmod.fascicles.fascicle.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">extracel_context</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">intracel_context</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rec_context</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save a fascicle in a json file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fname : str</span>
<span class="sd">            name of the file to save the fascicle</span>
<span class="sd">        extracel_context: bool</span>
<span class="sd">            if True, add the extracellular context to the saving</span>
<span class="sd">        intracel_context: bool</span>
<span class="sd">            if True, add the intracellular context to the saving</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">MCH</span><span class="o">.</span><span class="n">do_master_only_work</span><span class="p">():</span>
            <span class="c1"># copy everything into a dictionnary</span>
            <span class="n">fascicle_config</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">fascicle_config</span><span class="p">[</span><span class="s1">&#39;nrv_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrv_type</span>
            <span class="n">fascicle_config</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ID</span>
            <span class="n">fascicle_config</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span>
            <span class="n">fascicle_config</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D</span>
            <span class="n">fascicle_config</span><span class="p">[</span><span class="s1">&#39;y_grav_center&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_grav_center</span>
            <span class="n">fascicle_config</span><span class="p">[</span><span class="s1">&#39;z_grav_center&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_grav_center</span>
            <span class="n">fascicle_config</span><span class="p">[</span><span class="s1">&#39;N_vertices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_vertices</span>
            <span class="n">fascicle_config</span><span class="p">[</span><span class="s1">&#39;y_vertices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_vertices</span>
            <span class="n">fascicle_config</span><span class="p">[</span><span class="s1">&#39;z_vertices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_vertices</span>
            <span class="n">fascicle_config</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">A</span>
            <span class="n">fascicle_config</span><span class="p">[</span><span class="s1">&#39;axons_diameter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span>
            <span class="n">fascicle_config</span><span class="p">[</span><span class="s1">&#39;axons_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_type</span>
            <span class="n">fascicle_config</span><span class="p">[</span><span class="s1">&#39;axons_y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_y</span>
            <span class="n">fascicle_config</span><span class="p">[</span><span class="s1">&#39;axons_z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_z</span>
            <span class="n">fascicle_config</span><span class="p">[</span><span class="s1">&#39;NoR_relative_position&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NoR_relative_position</span>

            <span class="k">if</span> <span class="n">intracel_context</span><span class="p">:</span>
                <span class="n">fascicle_config</span><span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span>
                <span class="n">fascicle_config</span><span class="p">[</span><span class="s1">&#39;N_intra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_intra</span>
                <span class="n">fascicle_config</span><span class="p">[</span><span class="s1">&#39;intra_stim_position&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_position</span>
                <span class="n">fascicle_config</span><span class="p">[</span><span class="s1">&#39;intra_stim_t_start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_t_start</span>
                <span class="n">fascicle_config</span><span class="p">[</span><span class="s1">&#39;intra_stim_duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_duration</span>
                <span class="n">fascicle_config</span><span class="p">[</span><span class="s1">&#39;intra_stim_amplitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_amplitude</span>
                <span class="n">fascicle_config</span><span class="p">[</span><span class="s1">&#39;intra_stim_ON&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_ON</span>
            <span class="k">if</span> <span class="n">extracel_context</span><span class="p">:</span>
                <span class="n">fascicle_config</span><span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span>
                <span class="n">fascicle_config</span><span class="p">[</span><span class="s1">&#39;extra_stim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_stim</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="n">fascicle_config</span><span class="p">[</span><span class="s1">&#39;footprints&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">footprints</span>
                <span class="n">fascicle_config</span><span class="p">[</span><span class="s1">&#39;myelinated_nseg_per_sec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">myelinated_nseg_per_sec</span>
                <span class="n">fascicle_config</span><span class="p">[</span><span class="s1">&#39;unmyelinated_nseg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unmyelinated_nseg</span>
                <span class="n">fascicle_config</span><span class="p">[</span><span class="s1">&#39;is_footprinted&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_footprinted</span>

            <span class="k">if</span> <span class="n">rec_context</span><span class="p">:</span>
                <span class="n">fascicle_config</span><span class="p">[</span><span class="s1">&#39;record&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">record</span>
                <span class="n">fascicle_config</span><span class="p">[</span><span class="s1">&#39;recorder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recorder</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="c1"># save the dictionnary as a json file</span>
            <span class="n">json_dump</span><span class="p">(</span><span class="n">fascicle_config</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span></div>

<div class="viewcode-block" id="fascicle.load"><a class="viewcode-back" href="../../../nrv.nmod.html#nrv.nmod.fascicles.fascicle.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">extracel_context</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">intracel_context</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rec_context</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load a fascicle configuration from a json file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fname           : str</span>
<span class="sd">            path to the json file describing a fascicle</span>
<span class="sd">        extracel_context: bool</span>
<span class="sd">            if True, load the extracellular context as well</span>
<span class="sd">        intracel_context: bool</span>
<span class="sd">            if True, load the intracellular context as well</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">json_load</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">results</span> <span class="o">=</span> <span class="n">fname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ID</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_grav_center</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;y_grav_center&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_grav_center</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;z_grav_center&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N_vertices</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;N_vertices&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_vertices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;y_vertices&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_vertices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;z_vertices&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;axons_diameter&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axons_type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;axons_type&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axons_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;axons_y&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axons_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;axons_z&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NoR_relative_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;NoR_relative_position&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;D&#39;</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">D</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rise_warning</span><span class="p">(</span><span class="s1">&#39;Diameter not save in json, by default fitted to axon distribution&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fit_circular_contour</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">intracel_context</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">N_intra</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;N_intra&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_position</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;intra_stim_position&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_t_start</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;intra_stim_t_start&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_duration</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;intra_stim_duration&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_amplitude</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;intra_stim_amplitude&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_ON</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;intra_stim_ON&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">extracel_context</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_footprinted</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;is_footprinted&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;myelinated_nseg_per_sec&#39;</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">myelinated_nseg_per_sec</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;myelinated_nseg_per_sec&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;unmyelinated_nseg&#39;</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unmyelinated_nseg</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;unmyelinated_nseg&#39;</span><span class="p">]</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">extra_stim</span> <span class="o">=</span> <span class="n">load_any</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;extra_stim&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">footprints</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">axon</span><span class="p">,</span> <span class="n">ftp</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;footprints&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">dic</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">dim</span><span class="p">,</span> <span class="n">ftpx</span> <span class="ow">in</span> <span class="n">ftp</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">dic</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">dim</span><span class="p">)]</span> <span class="o">=</span> <span class="n">ftpx</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">footprints</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">axon</span><span class="p">)]</span> <span class="o">=</span> <span class="n">dic</span>
            
        <span class="k">if</span> <span class="n">rec_context</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">record</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;record&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recorder</span> <span class="o">=</span> <span class="n">recorder</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recorder</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;recorder&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="fascicle.save_fascicle_configuration"><a class="viewcode-back" href="../../../nrv.nmod.html#nrv.nmod.fascicles.fascicle.save_fascicle_configuration">[docs]</a>    <span class="k">def</span> <span class="nf">save_fascicle_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">extracel_context</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">intracel_context</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rec_context</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">rise_warning</span><span class="p">(</span><span class="s1">&#39;save_fascicle_configuration is a deprecated method use save instead&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">fname</span><span class="p">,</span><span class="n">extracel_context</span><span class="o">=</span><span class="n">extracel_context</span><span class="p">,</span><span class="n">intracel_context</span><span class="o">=</span><span class="n">intracel_context</span><span class="p">,</span><span class="n">rec_context</span><span class="o">=</span><span class="n">rec_context</span><span class="p">)</span></div>
<div class="viewcode-block" id="fascicle.load_fascicle_configuration"><a class="viewcode-back" href="../../../nrv.nmod.html#nrv.nmod.fascicles.fascicle.load_fascicle_configuration">[docs]</a>    <span class="k">def</span> <span class="nf">load_fascicle_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">extracel_context</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">intracel_context</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rec_context</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">rise_warning</span><span class="p">(</span><span class="s1">&#39;load_fascicle_configuration is a deprecated method use load instead&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">fname</span><span class="p">,</span><span class="n">extracel_context</span><span class="o">=</span><span class="n">extracel_context</span><span class="p">,</span><span class="n">intracel_context</span><span class="o">=</span><span class="n">intracel_context</span><span class="p">,</span><span class="n">rec_context</span><span class="o">=</span><span class="n">rec_context</span><span class="p">)</span></div>

<div class="viewcode-block" id="fascicle.set_ID"><a class="viewcode-back" href="../../../nrv.nmod.html#nrv.nmod.fascicles.fascicle.set_ID">[docs]</a>    <span class="k">def</span> <span class="nf">set_ID</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ID</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        set the ID of the fascicle</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ID : int</span>
<span class="sd">            ID number of the fascicle</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ID</span> <span class="o">=</span> <span class="n">ID</span></div>

<div class="viewcode-block" id="fascicle.define_length"><a class="viewcode-back" href="../../../nrv.nmod.html#nrv.nmod.fascicles.fascicle.define_length">[docs]</a>    <span class="k">def</span> <span class="nf">define_length</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">L</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        set the length over the x axis of the fascicle</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        L   : float</span>
<span class="sd">            length of the fascicle in um</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">L</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unmyelinated_nseg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">//</span><span class="mi">25</span></div>

    <span class="c1">## generate stereotypic Fascicle</span>
<div class="viewcode-block" id="fascicle.define_circular_contour"><a class="viewcode-back" href="../../../nrv.nmod.html#nrv.nmod.fascicles.fascicle.define_circular_contour">[docs]</a>    <span class="k">def</span> <span class="nf">define_circular_contour</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">y_c</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">z_c</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">N_vertices</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define a circular countour to the fascicle</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        D           : float</span>
<span class="sd">            diameter of the circular fascicle contour, in um</span>
<span class="sd">        y_c         : float</span>
<span class="sd">            y coordinate of the circular contour center, in um</span>
<span class="sd">        z_c         : float</span>
<span class="sd">            z coordinate of the circular contour center, in um</span>
<span class="sd">        N_vertices  : int</span>
<span class="sd">            Number of vertice in the compute the contour</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s1">&#39;Circular&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">D</span> <span class="o">=</span> <span class="n">D</span>
        <span class="k">if</span> <span class="n">y_c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y_grav_center</span> <span class="o">=</span> <span class="n">y_c</span>
        <span class="k">if</span> <span class="n">z_c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">z_grav_center</span> <span class="o">=</span> <span class="n">z_c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N_vertices</span> <span class="o">=</span> <span class="n">N_vertices</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">N_vertices</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_vertices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_grav_center</span> <span class="o">+</span> <span class="p">(</span><span class="n">D</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_vertices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_grav_center</span> <span class="o">+</span> <span class="p">(</span><span class="n">D</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">D</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span></div>

<div class="viewcode-block" id="fascicle.get_circular_contour"><a class="viewcode-back" href="../../../nrv.nmod.html#nrv.nmod.fascicles.fascicle.get_circular_contour">[docs]</a>    <span class="k">def</span> <span class="nf">get_circular_contour</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the properties of the fascicle contour considered as a circle (y and z center and diameter)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        D : float</span>
<span class="sd">            diameter of the contour, in um. Set to 0 if not applicable</span>
<span class="sd">        y : float</span>
<span class="sd">            y position of the contour center, in um</span>
<span class="sd">        z : float</span>
<span class="sd">            z position of the contour center, in um</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_grav_center</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_grav_center</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_vertices</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">D</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">D</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">D</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_vertices</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_vertices</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z_vertices</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z_vertices</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_vertices</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_vertices</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">D</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span></div>

<div class="viewcode-block" id="fascicle.fit_circular_contour"><a class="viewcode-back" href="../../../nrv.nmod.html#nrv.nmod.fascicles.fascicle.fit_circular_contour">[docs]</a>    <span class="k">def</span> <span class="nf">fit_circular_contour</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_c</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">z_c</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Delta</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">N_vertices</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define a circular countour to the fascicle</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        y_c         : float</span>
<span class="sd">            y coordinate of the circular contour center, in um</span>
<span class="sd">        z_c         : float</span>
<span class="sd">            z coordinate of the circular contour center, in um</span>
<span class="sd">        Delta       : float</span>
<span class="sd">            distance between farest axon and contour, in um</span>
<span class="sd">        N_vertices  : int</span>
<span class="sd">            Number of vertice in the compute the contour</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">N_axons</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span><span class="p">)</span>
        <span class="n">D</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">Delta</span>

        <span class="k">if</span> <span class="n">y_c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y_grav_center</span> <span class="o">=</span> <span class="n">y_c</span>
        <span class="k">if</span> <span class="n">z_c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">z_grav_center</span> <span class="o">=</span> <span class="n">z_c</span>
        <span class="k">if</span> <span class="n">N_axons</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pass_info</span><span class="p">(</span><span class="s1">&#39;No axon to fit fascicul diameter set to &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">D</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;um&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">axon</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_axons</span><span class="p">):</span>
                <span class="n">dist_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span><span class="p">[</span><span class="n">axon</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">y_grav_center</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_y</span><span class="p">[</span><span class="n">axon</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>\
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z_grav_center</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_z</span><span class="p">[</span><span class="n">axon</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
                <span class="n">D</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">dist_max</span><span class="o">+</span><span class="n">Delta</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">define_circular_contour</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">y_c</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">z_c</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">N_vertices</span><span class="o">=</span><span class="n">N_vertices</span><span class="p">)</span></div>

<div class="viewcode-block" id="fascicle.define_ellipsoid_contour"><a class="viewcode-back" href="../../../nrv.nmod.html#nrv.nmod.fascicles.fascicle.define_ellipsoid_contour">[docs]</a>    <span class="k">def</span> <span class="nf">define_ellipsoid_contour</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">y_c</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">z_c</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">rotate</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define ellipsoidal contour</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="c1">## generate Fascicle from histology</span>
<div class="viewcode-block" id="fascicle.import_contour"><a class="viewcode-back" href="../../../nrv.nmod.html#nrv.nmod.fascicles.fascicle.import_contour">[docs]</a>    <span class="k">def</span> <span class="nf">import_contour</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smthing_else</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define contour from a file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="c1">## fill fascicle methods</span>
<div class="viewcode-block" id="fascicle.fill"><a class="viewcode-back" href="../../../nrv.nmod.html#nrv.nmod.fascicles.fascicle.fill">[docs]</a>    <span class="k">def</span> <span class="nf">fill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">percent_unmyel</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">FVF</span><span class="o">=</span><span class="mf">0.55</span><span class="p">,</span> <span class="n">M_stat</span><span class="o">=</span><span class="s1">&#39;Schellens_1&#39;</span><span class="p">,</span>\
        <span class="n">U_stat</span><span class="o">=</span><span class="s1">&#39;Ochoa_U&#39;</span><span class="p">,</span> <span class="n">ppop_fname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pop_fname</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fill a geometricaly defined contour with axons</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        parallel        : bool</span>
<span class="sd">            if True, the generation process (quite long) is split over multiples cores, if False everything is perfrmed by the master.</span>
<span class="sd">        percent_unmyel  : float</span>
<span class="sd">            ratio of unmyelinated axons in the population. Should be between 0 and 1.</span>
<span class="sd">        FVF             : float</span>
<span class="sd">            Fiber Volume Fraction estimated for the area. By default set to 0.55</span>
<span class="sd">        M_stat          : str</span>
<span class="sd">            name of the statistic in the librairy or path to a new librairy in csv for myelinated diameters repartition</span>
<span class="sd">        U_stat          : str</span>
<span class="sd">            name of the statistic in the librairy or path to a new librairy in csv for unmyelinated diameters repartition</span>
<span class="sd">        ppop_fname      : str</span>
<span class="sd">            optional, if specified, name file to store the placed population generated</span>
<span class="sd">        pop_fname       : str</span>
<span class="sd">            optional, if specified, name file to store the population generated</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#### AXON GENERATION: parallelization if resquested ####</span>
        <span class="n">Area_to_fill</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Note: generate a bit too much axons just in case</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;Circular&#39;</span><span class="p">:</span>
            <span class="n">Area_to_fill</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">28</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">if</span> <span class="n">parallel</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">MCH</span><span class="o">.</span><span class="n">do_master_only_work</span><span class="p">():</span>
                <span class="n">pass_info</span><span class="p">(</span><span class="s1">&#39;Generating axons&#39;</span><span class="p">)</span>
            <span class="c1"># split the generation over the N cores</span>
            <span class="n">partial_axons_diameter</span><span class="p">,</span> <span class="n">partial_axons_type</span><span class="p">,</span> <span class="n">M_diam_list</span><span class="p">,</span> <span class="n">U_diam_list</span> <span class="o">=</span> \
            <span class="n">fill_area_with_axons</span><span class="p">(</span><span class="n">Area_to_fill</span><span class="o">/</span><span class="n">MCH</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">percent_unmyel</span><span class="o">=</span><span class="n">percent_unmyel</span><span class="p">,</span> \
                <span class="n">FVF</span><span class="o">=</span><span class="n">FVF</span><span class="p">,</span> <span class="n">M_stat</span><span class="o">=</span><span class="n">M_stat</span><span class="p">,</span> <span class="n">U_stat</span><span class="o">=</span><span class="n">U_stat</span><span class="p">)</span>
            <span class="c1"># gather results</span>
            <span class="n">axons_diameter</span> <span class="o">=</span> <span class="n">MCH</span><span class="o">.</span><span class="n">gather_jobs_as_array</span><span class="p">(</span><span class="n">partial_axons_diameter</span><span class="p">)</span>
            <span class="n">axons_type</span> <span class="o">=</span> <span class="n">MCH</span><span class="o">.</span><span class="n">gather_jobs_as_array</span><span class="p">(</span><span class="n">partial_axons_type</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">MCH</span><span class="o">.</span><span class="n">do_master_only_work</span><span class="p">():</span>
                <span class="n">axons_diameter</span><span class="p">,</span> <span class="n">axons_type</span><span class="p">,</span> <span class="n">M_diam_list</span><span class="p">,</span> <span class="n">U_diam_list</span> <span class="o">=</span> <span class="n">fill_area_with_axons</span><span class="p">(</span>\
                    <span class="n">Area_to_fill</span><span class="p">,</span> <span class="n">percent_unmyel</span><span class="o">=</span><span class="n">percent_unmyel</span><span class="p">,</span> <span class="n">FVF</span><span class="o">=</span><span class="n">FVF</span><span class="p">,</span> <span class="n">M_stat</span><span class="o">=</span><span class="n">M_stat</span><span class="p">,</span>\
                    <span class="n">U_stat</span><span class="o">=</span><span class="n">U_stat</span><span class="p">)</span>
        <span class="c1">#### AXON PACKING: never parallel</span>
        <span class="k">if</span> <span class="n">MCH</span><span class="o">.</span><span class="n">do_master_only_work</span><span class="p">():</span>
            <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">axons_diameter</span><span class="p">)</span>
            <span class="n">pass_info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> ... &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; axons generated&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pop_fname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">save_axon_population</span><span class="p">(</span><span class="n">pop_fname</span><span class="p">,</span> <span class="n">axons_diameter</span><span class="p">,</span> <span class="n">axons_type</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">pass_info</span><span class="p">(</span><span class="s1">&#39;Axon Packing is starting&#39;</span><span class="p">)</span>
            <span class="n">axons_y</span><span class="p">,</span> <span class="n">axons_z</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">FVF_array</span><span class="p">,</span> <span class="n">probed_iter</span> <span class="o">=</span> <span class="n">axon_packer</span><span class="p">(</span><span class="n">axons_diameter</span><span class="p">,</span>\
                <span class="n">Delta</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">y_gc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y_grav_center</span><span class="p">,</span> <span class="n">z_gc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">z_grav_center</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">20000</span><span class="p">,</span>\
                <span class="n">monitor</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># check for remaining collisions and delete problematic axons</span>
            <span class="n">axons_diameter</span><span class="p">,</span> <span class="n">axons_type</span><span class="p">,</span> <span class="n">axons_y</span><span class="p">,</span> <span class="n">axons_z</span> <span class="o">=</span> <span class="n">delete_collisions</span><span class="p">(</span><span class="n">axons_diameter</span><span class="p">,</span>\
                <span class="n">axons_type</span><span class="p">,</span> <span class="n">axons_y</span><span class="p">,</span> <span class="n">axons_z</span><span class="p">)</span>
            <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">axons_diameter</span><span class="p">)</span>
            <span class="n">pass_info</span><span class="p">(</span><span class="s1">&#39;... Axon Packing done&#39;</span><span class="p">)</span>
            <span class="c1"># check if axons are inside the fascicle</span>
            <span class="n">inside_axons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">axons_y</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_grav_center</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">axons_z</span> <span class="o">-</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">z_grav_center</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">axons_diameter</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">axons_to_keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">inside_axons</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">axons_diameter</span> <span class="o">=</span> <span class="n">axons_diameter</span><span class="p">[</span><span class="n">axons_to_keep</span><span class="p">]</span>
            <span class="n">axons_type</span> <span class="o">=</span> <span class="n">axons_type</span><span class="p">[</span><span class="n">axons_to_keep</span><span class="p">]</span>
            <span class="n">axons_y</span> <span class="o">=</span> <span class="n">axons_y</span><span class="p">[</span><span class="n">axons_to_keep</span><span class="p">]</span>
            <span class="n">axons_z</span> <span class="o">=</span> <span class="n">axons_z</span><span class="p">[</span><span class="n">axons_to_keep</span><span class="p">]</span>
            <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">axons_diameter</span><span class="p">)</span>
            <span class="c1"># save the good population</span>
            <span class="k">if</span> <span class="n">ppop_fname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">save_placed_axon_population</span><span class="p">(</span><span class="n">ppop_fname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_type</span><span class="p">,</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">axons_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_z</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axons_diameter</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">axons_type</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">axons_y</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">axons_z</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">N</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">## BRODCASTING RESULTS TO ALL PARALLEL OBJECTS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span> <span class="o">=</span> <span class="n">MCH</span><span class="o">.</span><span class="n">master_broadcasts_array_to_all</span><span class="p">(</span><span class="n">axons_diameter</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axons_type</span> <span class="o">=</span> <span class="n">MCH</span><span class="o">.</span><span class="n">master_broadcasts_array_to_all</span><span class="p">(</span><span class="n">axons_type</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axons_y</span> <span class="o">=</span> <span class="n">MCH</span><span class="o">.</span><span class="n">master_broadcasts_array_to_all</span><span class="p">(</span><span class="n">axons_y</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axons_z</span> <span class="o">=</span> <span class="n">MCH</span><span class="o">.</span><span class="n">master_broadcasts_array_to_all</span><span class="p">(</span><span class="n">axons_z</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">MCH</span><span class="o">.</span><span class="n">master_broadcasts_array_to_all</span><span class="p">(</span><span class="n">N</span><span class="p">)</span></div>

<div class="viewcode-block" id="fascicle.fill_with_population"><a class="viewcode-back" href="../../../nrv.nmod.html#nrv.nmod.fascicles.fascicle.fill_with_population">[docs]</a>    <span class="k">def</span> <span class="nf">fill_with_population</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axons_diameter</span><span class="p">,</span> <span class="n">axons_type</span><span class="p">,</span> <span class="n">Delta</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">ppop_fname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">FVF</span><span class="o">=</span><span class="mf">0.55</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fill a geometricaly defined contour with an already generated axon population</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        axons_diameters     : np.array</span>
<span class="sd">            Array  containing all the diameters of the axon population</span>
<span class="sd">        axons_type          : np.array</span>
<span class="sd">            Array containing a &#39;1&#39; value for indexes where the axon is myelinated (A-delta or not), else &#39;0&#39;</span>
<span class="sd">        ppop_fname      : str</span>
<span class="sd">            optional, if specified, name file to store the placed population generated</span>
<span class="sd">        FVF             : float</span>
<span class="sd">            Fiber Volume Fraction estimated for the area. By default set to 0.55</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">MCH</span><span class="o">.</span><span class="n">do_master_only_work</span><span class="p">():</span>
            <span class="c1">## check the population area</span>
            <span class="n">total_ax_area</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">diam</span> <span class="ow">in</span> <span class="n">axons_diameter</span><span class="p">:</span>
                <span class="n">total_ax_area</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">((</span><span class="n">diam</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="o">*</span><span class="n">FVF</span> <span class="o">&gt;</span> <span class="n">total_ax_area</span><span class="p">:</span>
                <span class="n">rise_warning</span><span class="p">(</span><span class="s1">&#39;Warning: the specified population maybe too small to fill the current fascicle&#39;</span><span class="p">)</span>
            <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">axons_diameter</span><span class="p">)</span>
            <span class="n">pass_info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> ... &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; axons loaded&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ppop_fname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">save_axon_population</span><span class="p">(</span><span class="n">ppop_fname</span><span class="p">,</span> <span class="n">axons_diameter</span><span class="p">,</span> <span class="n">axons_type</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">pass_info</span><span class="p">(</span><span class="s1">&#39;Axon Packing is starting&#39;</span><span class="p">)</span>
            <span class="n">axons_y</span><span class="p">,</span> <span class="n">axons_z</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">FVF_array</span><span class="p">,</span> <span class="n">probed_iter</span> <span class="o">=</span> <span class="n">axon_packer</span><span class="p">(</span><span class="n">axons_diameter</span><span class="p">,</span>\
                <span class="n">Delta</span><span class="o">=</span><span class="n">Delta</span><span class="p">,</span> <span class="n">y_gc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y_grav_center</span><span class="p">,</span> <span class="n">z_gc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">z_grav_center</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">20000</span><span class="p">,</span>\
                <span class="n">monitor</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># check for remaining collisions and delete problematic axons</span>
            <span class="n">axons_diameter</span><span class="p">,</span> <span class="n">axons_type</span><span class="p">,</span> <span class="n">axons_y</span><span class="p">,</span> <span class="n">axons_z</span> <span class="o">=</span> <span class="n">delete_collisions</span><span class="p">(</span><span class="n">axons_diameter</span><span class="p">,</span>\
                <span class="n">axons_type</span><span class="p">,</span> <span class="n">axons_y</span><span class="p">,</span> <span class="n">axons_z</span><span class="p">)</span>
            <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">axons_diameter</span><span class="p">)</span>
            <span class="n">pass_info</span><span class="p">(</span><span class="s1">&#39;... Axon Packing done&#39;</span><span class="p">)</span>
            <span class="c1"># check if axons are inside the fascicle</span>
            <span class="n">inside_axons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">axons_y</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_grav_center</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">axons_z</span> <span class="o">-</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">z_grav_center</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">axons_diameter</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">axons_to_keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">inside_axons</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">axons_diameter</span> <span class="o">=</span> <span class="n">axons_diameter</span><span class="p">[</span><span class="n">axons_to_keep</span><span class="p">]</span>
            <span class="n">axons_type</span> <span class="o">=</span> <span class="n">axons_type</span><span class="p">[</span><span class="n">axons_to_keep</span><span class="p">]</span>
            <span class="n">axons_y</span> <span class="o">=</span> <span class="n">axons_y</span><span class="p">[</span><span class="n">axons_to_keep</span><span class="p">]</span>
            <span class="n">axons_z</span> <span class="o">=</span> <span class="n">axons_z</span><span class="p">[</span><span class="n">axons_to_keep</span><span class="p">]</span>
            <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">axons_diameter</span><span class="p">)</span>
            <span class="c1"># save the good population</span>
            <span class="k">if</span> <span class="n">ppop_fname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">save_placed_axon_population</span><span class="p">(</span><span class="n">ppop_fname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_type</span><span class="p">,</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">axons_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_z</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axons_diameter</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">axons_type</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">axons_y</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">axons_z</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">N</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">## BRODCASTING RESULTS TO ALL PARALLEL OBJECTS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span> <span class="o">=</span> <span class="n">MCH</span><span class="o">.</span><span class="n">master_broadcasts_array_to_all</span><span class="p">(</span><span class="n">axons_diameter</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axons_type</span> <span class="o">=</span> <span class="n">MCH</span><span class="o">.</span><span class="n">master_broadcasts_array_to_all</span><span class="p">(</span><span class="n">axons_type</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axons_y</span> <span class="o">=</span> <span class="n">MCH</span><span class="o">.</span><span class="n">master_broadcasts_array_to_all</span><span class="p">(</span><span class="n">axons_y</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axons_z</span> <span class="o">=</span> <span class="n">MCH</span><span class="o">.</span><span class="n">master_broadcasts_array_to_all</span><span class="p">(</span><span class="n">axons_z</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">MCH</span><span class="o">.</span><span class="n">master_broadcasts_array_to_all</span><span class="p">(</span><span class="n">N</span><span class="p">)</span></div>

<div class="viewcode-block" id="fascicle.fill_with_placed_population"><a class="viewcode-back" href="../../../nrv.nmod.html#nrv.nmod.fascicles.fascicle.fill_with_placed_population">[docs]</a>    <span class="k">def</span> <span class="nf">fill_with_placed_population</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axons_diameter</span><span class="p">,</span> <span class="n">axons_type</span><span class="p">,</span> <span class="n">axons_y</span><span class="p">,</span> <span class="n">axons_z</span><span class="p">,</span>\
        <span class="n">check_inside</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check_collision</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ppop_fname</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fill a geometricaly defined contour with an already generated axon population</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        axons_diameters     : np.array</span>
<span class="sd">            Array  containing all the diameters of the axon population</span>
<span class="sd">        axons_type          : np.array</span>
<span class="sd">            Array containing a &#39;1&#39; value for indexes where the axon is myelinated (A-delta or not), else &#39;0&#39;</span>
<span class="sd">        axons_y             : np.array</span>
<span class="sd">            y coordinate of the axons, in um</span>
<span class="sd">        axons_z             : np.array</span>
<span class="sd">            z coordinate of the axons, in um</span>
<span class="sd">        check_inside        : bool</span>
<span class="sd">            if True the placed axons position are checked to ensure all remaining axons at the end are inside the fascicle</span>
<span class="sd">        check_collision     : bool</span>
<span class="sd">            if True, possible remaining collisions are check in the loaded population, and thiner axons are deleted</span>
<span class="sd">        ppop_fname          : str</span>
<span class="sd">            optional, if specified, name file to store the placed population generated</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">MCH</span><span class="o">.</span><span class="n">do_master_only_work</span><span class="p">():</span>
            <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">axons_diameter</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">check_collision</span><span class="p">:</span>
                <span class="c1"># check for remaining collisions and delete problematic axons</span>
                <span class="n">axons_diameter</span><span class="p">,</span> <span class="n">axons_type</span><span class="p">,</span> <span class="n">axons_y</span><span class="p">,</span> <span class="n">axons_z</span> <span class="o">=</span> <span class="n">delete_collisions</span><span class="p">(</span><span class="n">axons_diameter</span><span class="p">,</span>\
                    <span class="n">axons_type</span><span class="p">,</span> <span class="n">axons_y</span><span class="p">,</span> <span class="n">axons_z</span><span class="p">)</span>
                <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">axons_diameter</span><span class="p">)</span>
            <span class="c1"># check if axons are inside the fascicle</span>
            <span class="k">if</span> <span class="n">check_inside</span><span class="p">:</span>
                <span class="n">inside_axons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">axons_y</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_grav_center</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span>\
                    <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">axons_z</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_grav_center</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>\
                    <span class="o">-</span><span class="n">axons_diameter</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">axons_to_keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">inside_axons</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">axons_diameter</span> <span class="o">=</span> <span class="n">axons_diameter</span><span class="p">[</span><span class="n">axons_to_keep</span><span class="p">]</span>
                <span class="n">axons_type</span> <span class="o">=</span> <span class="n">axons_type</span><span class="p">[</span><span class="n">axons_to_keep</span><span class="p">]</span>
                <span class="n">axons_y</span> <span class="o">=</span> <span class="n">axons_y</span><span class="p">[</span><span class="n">axons_to_keep</span><span class="p">]</span>
                <span class="n">axons_z</span> <span class="o">=</span> <span class="n">axons_z</span><span class="p">[</span><span class="n">axons_to_keep</span><span class="p">]</span>
                <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">axons_diameter</span><span class="p">)</span>
            <span class="c1"># save the good population</span>
            <span class="k">if</span> <span class="n">ppop_fname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">save_placed_axon_population</span><span class="p">(</span><span class="n">ppop_fname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_type</span><span class="p">,</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">axons_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_z</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axons_diameter</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">axons_type</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">axons_y</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">axons_z</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">N</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">## BRODCASTING RESULTS TO ALL PARALLEL OBJECTS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span> <span class="o">=</span> <span class="n">MCH</span><span class="o">.</span><span class="n">master_broadcasts_array_to_all</span><span class="p">(</span><span class="n">axons_diameter</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axons_type</span> <span class="o">=</span> <span class="n">MCH</span><span class="o">.</span><span class="n">master_broadcasts_array_to_all</span><span class="p">(</span><span class="n">axons_type</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axons_y</span> <span class="o">=</span> <span class="n">MCH</span><span class="o">.</span><span class="n">master_broadcasts_array_to_all</span><span class="p">(</span><span class="n">axons_y</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axons_z</span> <span class="o">=</span> <span class="n">MCH</span><span class="o">.</span><span class="n">master_broadcasts_array_to_all</span><span class="p">(</span><span class="n">axons_z</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">MCH</span><span class="o">.</span><span class="n">master_broadcasts_array_to_all</span><span class="p">(</span><span class="n">N</span><span class="p">)</span></div>

    <span class="c1">## move methods</span>
<div class="viewcode-block" id="fascicle.translate_axons"><a class="viewcode-back" href="../../../nrv.nmod.html#nrv.nmod.fascicles.fascicle.translate_axons">[docs]</a>    <span class="k">def</span> <span class="nf">translate_axons</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Move axons only in a fascicle by group translation</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        y   : float</span>
<span class="sd">            y axis value for the translation in um</span>
<span class="sd">        z   : float</span>
<span class="sd">            z axis value for the translation in um</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axons_y</span> <span class="o">+=</span> <span class="n">y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axons_z</span> <span class="o">+=</span> <span class="n">z</span></div>

<div class="viewcode-block" id="fascicle.translate_fascicle"><a class="viewcode-back" href="../../../nrv.nmod.html#nrv.nmod.fascicles.fascicle.translate_fascicle">[docs]</a>    <span class="k">def</span> <span class="nf">translate_fascicle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Translate a complete fascicle</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        y   : float</span>
<span class="sd">            y axis value for the translation in um</span>
<span class="sd">        z   : float</span>
<span class="sd">            z axis value for the translation in um</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_grav_center</span> <span class="o">+=</span> <span class="n">y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_grav_center</span> <span class="o">+=</span> <span class="n">z</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_vertices</span> <span class="o">+=</span> <span class="n">y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_vertices</span> <span class="o">+=</span> <span class="n">z</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">translate_axons</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span></div>

<div class="viewcode-block" id="fascicle.rotate_axons"><a class="viewcode-back" href="../../../nrv.nmod.html#nrv.nmod.fascicles.fascicle.rotate_axons">[docs]</a>    <span class="k">def</span> <span class="nf">rotate_axons</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">y_c</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">z_c</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Move axons only in a fascicle by group rotation</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        theta   : float</span>
<span class="sd">            angular value of the translation, in rad</span>
<span class="sd">        y_c     : float</span>
<span class="sd">            y axis value of the rotation center in um, by default set to 0</span>
<span class="sd">        z_c     : float</span>
<span class="sd">            z axis value for the rotation center in um, by default set to 0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axons_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axons_y</span> <span class="o">-</span> <span class="n">y_c</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span>\
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axons_z</span> <span class="o">-</span> <span class="n">z_c</span><span class="p">))</span> <span class="o">+</span> <span class="n">y_c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axons_z</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axons_y</span> <span class="o">-</span> <span class="n">y_c</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span>\
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axons_z</span> <span class="o">-</span> <span class="n">z_c</span><span class="p">))</span> <span class="o">+</span> <span class="n">z_c</span></div>

<div class="viewcode-block" id="fascicle.rotate_fascicle"><a class="viewcode-back" href="../../../nrv.nmod.html#nrv.nmod.fascicles.fascicle.rotate_fascicle">[docs]</a>    <span class="k">def</span> <span class="nf">rotate_fascicle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">y_c</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">z_c</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rotate a complete fascicle</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        theta   : float</span>
<span class="sd">            angular value of the translation, in rad</span>
<span class="sd">        y_c     : float</span>
<span class="sd">            y axis value of the rotation center in um, by default set to 0</span>
<span class="sd">        z_c     : float</span>
<span class="sd">            z axis value for the rotation center in um, by default set to 0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_grav_center</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_grav_center</span> <span class="o">-</span> <span class="n">y_c</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span>\
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z_grav_center</span> <span class="o">-</span> <span class="n">z_c</span><span class="p">))</span> <span class="o">+</span> <span class="n">y_c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_grav_center</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_grav_center</span> <span class="o">-</span> <span class="n">y_c</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span>\
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z_grav_center</span> <span class="o">-</span> <span class="n">z_c</span><span class="p">))</span> <span class="o">+</span> <span class="n">z_c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_vertices</span> <span class="o">+=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_vertices</span> <span class="o">-</span> <span class="n">y_c</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span>\
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z_vertices</span> <span class="o">-</span> <span class="n">z_c</span><span class="p">))</span> <span class="o">+</span> <span class="n">y_c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_vertices</span> <span class="o">+=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_vertices</span> <span class="o">-</span> <span class="n">y_c</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span>\
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z_vertices</span> <span class="o">-</span> <span class="n">z_c</span><span class="p">))</span> <span class="o">+</span> <span class="n">z_c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotate_axons</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">y_c</span><span class="o">=</span><span class="n">y_c</span><span class="p">,</span> <span class="n">z_c</span><span class="o">=</span><span class="n">z_c</span><span class="p">)</span></div>

<div class="viewcode-block" id="fascicle.remove_axons_electrode_overlap"><a class="viewcode-back" href="../../../nrv.nmod.html#nrv.nmod.fascicles.fascicle.remove_axons_electrode_overlap">[docs]</a>    <span class="k">def</span> <span class="nf">remove_axons_electrode_overlap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">electrode</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove the axons that could overlap an electrode</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        electrode : object</span>
<span class="sd">            electrode instance, see electrodes for more details</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">is_LIFE_electrode</span><span class="p">(</span><span class="n">electrode</span><span class="p">):</span>
            <span class="n">D</span> <span class="o">=</span> <span class="n">electrode</span><span class="o">.</span><span class="n">D</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">electrode</span><span class="o">.</span><span class="n">y_c</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">electrode</span><span class="o">.</span><span class="n">z_c</span>
        <span class="k">elif</span> <span class="n">is_analytical_electrode</span><span class="p">(</span><span class="n">electrode</span><span class="p">):</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">electrode</span><span class="o">.</span><span class="n">y</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">electrode</span><span class="o">.</span><span class="n">z</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># CUFF electrodes should not affect intrafascicular state</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="c1"># compute the distance of all axons to electrode</span>
        <span class="n">D_vectors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">axons_y</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axons_z</span> <span class="o">-</span> <span class="n">z</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">D</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">colapse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">D_vectors</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">colapse</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># remove axons colliding the electrode</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">colapse</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">pass_info</span><span class="p">(</span><span class="s1">&#39;From Fascicle level: Electrode/Axons overlap, &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">colapse</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; axons will be removed from the fascicle&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">colapse</span><span class="p">)</span>
        <span class="n">pass_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="s2">&quot;axons remaining&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axons_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_type</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axons_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_y</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axons_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_z</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span></div>

<div class="viewcode-block" id="fascicle.remove_unmyelinated_axons"><a class="viewcode-back" href="../../../nrv.nmod.html#nrv.nmod.fascicles.fascicle.remove_unmyelinated_axons">[docs]</a>    <span class="k">def</span> <span class="nf">remove_unmyelinated_axons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove all unmyelinated fibers from the fascicle</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_type</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axons_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_y</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axons_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_z</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axons_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_type</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NoR_relative_position</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">NoR_relative_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NoR_relative_position</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span></div>

<div class="viewcode-block" id="fascicle.remove_myelinated_axons"><a class="viewcode-back" href="../../../nrv.nmod.html#nrv.nmod.fascicles.fascicle.remove_myelinated_axons">[docs]</a>    <span class="k">def</span> <span class="nf">remove_myelinated_axons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove all myelinated fibers from the</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axons_type</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axons_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_y</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axons_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_z</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axons_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_type</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NoR_relative_position</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># almost useless but here for coherence</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">NoR_relative_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NoR_relative_position</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span></div>

<div class="viewcode-block" id="fascicle.remove_axons_size_threshold"><a class="viewcode-back" href="../../../nrv.nmod.html#nrv.nmod.fascicles.fascicle.remove_axons_size_threshold">[docs]</a>    <span class="k">def</span> <span class="nf">remove_axons_size_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove fibers with diameters below/above a threshold</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">min</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span> <span class="o">&gt;=</span> <span class="n">d</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span> <span class="o">&lt;=</span> <span class="n">d</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axons_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_y</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axons_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_z</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axons_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_type</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NoR_relative_position</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># almost useless but here for coherence</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">NoR_relative_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NoR_relative_position</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span></div>

    <span class="c1">## representation methods</span>
<div class="viewcode-block" id="fascicle.plot"><a class="viewcode-back" href="../../../nrv.nmod.html#nrv.nmod.fascicles.fascicle.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">contour_color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">myel_color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">unmyel_color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        plot the fascicle in the Y-Z plane (transverse section)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fig     : matplotlib.figure</span>
<span class="sd">            figure to display the fascicle</span>
<span class="sd">        axes    : matplotlib.axes</span>
<span class="sd">            axes of the figure to display the fascicle</span>
<span class="sd">        contour_color   : str</span>
<span class="sd">            matplotlib color string applied to the contour. Black by default</span>
<span class="sd">        myel_color      : str</span>
<span class="sd">            matplotlib color string applied to the myelinated axons. Red by default</span>
<span class="sd">        unmyel_color    : str</span>
<span class="sd">            matplotlib color string applied to the myelinated axons. Blue by default</span>
<span class="sd">        num             : bool</span>
<span class="sd">            if True, the index of each axon is displayed on top of the circle</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">MCH</span><span class="o">.</span><span class="n">do_master_only_work</span><span class="p">():</span>
            <span class="c1">## plot contour</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_vertices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_vertices</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">contour_color</span><span class="p">)</span>
            <span class="c1">## plot axons</span>
            <span class="n">circles</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_type</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># myelinated</span>
                    <span class="n">circles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">axons_y</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_z</span><span class="p">[</span><span class="n">k</span><span class="p">]),</span>\
                        <span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">myel_color</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">circles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">axons_y</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_z</span><span class="p">[</span><span class="n">k</span><span class="p">]),</span>\
                        <span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">unmyel_color</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_stim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">electrode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_stim</span><span class="o">.</span><span class="n">electrodes</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">electrode</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;LIFE&quot;</span><span class="p">:</span>
                        <span class="n">circles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="n">electrode</span><span class="o">.</span><span class="n">y_c</span><span class="p">,</span> <span class="n">electrode</span><span class="o">.</span><span class="n">z_c</span><span class="p">),</span>\
                        <span class="n">electrode</span><span class="o">.</span><span class="n">D</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gold&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="ow">not</span> <span class="n">is_FEM_electrode</span><span class="p">(</span><span class="n">electrode</span><span class="p">):</span>
                        <span class="n">axes</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">electrode</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">electrode</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gold&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">circle</span> <span class="ow">in</span> <span class="n">circles</span><span class="p">:</span>
                <span class="n">axes</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">circle</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">num</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">):</span>
                    <span class="n">axes</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axons_y</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_z</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">))</span></div>


<div class="viewcode-block" id="fascicle.plot_x"><a class="viewcode-back" href="../../../nrv.nmod.html#nrv.nmod.fascicles.fascicle.plot_x">[docs]</a>    <span class="k">def</span> <span class="nf">plot_x</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">myel_color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">unmyel_color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">Myelinated_model</span><span class="o">=</span><span class="s1">&#39;MRG&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        plot the fascicle&#39;s axons along Xline (longitudinal)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fig     : matplotlib.figure</span>
<span class="sd">            figure to display the fascicle</span>
<span class="sd">        axes    : matplotlib.axes</span>
<span class="sd">            axes of the figure to display the fascicle</span>
<span class="sd">        myel_color      : str</span>
<span class="sd">            matplotlib color string applied to the myelinated axons. Red by default</span>
<span class="sd">        unmyel_color    : str</span>
<span class="sd">            matplotlib color string applied to the myelinated axons. Blue by default</span>
<span class="sd">        Myelinated_model : str</span>
<span class="sd">            model use for myelinated axon (use to calulated node position)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">MCH</span><span class="o">.</span><span class="n">do_master_only_work</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">NoR_relative_position</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="n">drange</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span><span class="o">.</span><span class="n">flatten</span><span class="p">()),</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span><span class="o">.</span><span class="n">flatten</span><span class="p">())]</span>
                <span class="n">polysize</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">drange</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">):</span>
                    <span class="n">relative_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NoR_relative_position</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">k</span><span class="p">],</span><span class="mi">2</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_type</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                        <span class="n">color</span> <span class="o">=</span> <span class="n">unmyel_color</span>
                        <span class="n">size</span> <span class="o">=</span> <span class="n">polysize</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                        <span class="n">axes</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">color</span> <span class="o">=</span> <span class="n">myel_color</span>
                        <span class="n">size</span> <span class="o">=</span> <span class="n">polysize</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                        <span class="n">axon</span> <span class="o">=</span> <span class="n">myelinated</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">Myelinated_model</span><span class="p">,</span>\
                            <span class="n">node_shift</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">NoR_relative_position</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                        <span class="n">x_nodes</span> <span class="o">=</span> <span class="n">axon</span><span class="o">.</span><span class="n">x_nodes</span>
                        <span class="n">node_number</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_nodes</span><span class="p">)</span>
                        <span class="k">del</span> <span class="n">axon</span>
                        <span class="n">axes</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
                        <span class="n">axes</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_nodes</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">node_number</span><span class="p">)</span><span class="o">+</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>

                <span class="c1">## plot electrode(s) if existings</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_stim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">electrode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_stim</span><span class="o">.</span><span class="n">electrodes</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_FEM_electrode</span><span class="p">(</span><span class="n">electrode</span><span class="p">):</span>
                            <span class="n">axes</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">electrode</span><span class="o">.</span><span class="n">x</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gold&#39;</span><span class="p">)</span>
                <span class="n">axes</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x (um)&#39;</span><span class="p">)</span>
                <span class="n">axes</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;axon ID&#39;</span><span class="p">)</span>
                <span class="n">axes</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">))</span>
                <span class="n">axes</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span></div>



    <span class="c1">## STIMULATION METHODS</span>
<div class="viewcode-block" id="fascicle.clear_context"><a class="viewcode-back" href="../../../nrv.nmod.html#nrv.nmod.fascicles.fascicle.clear_context">[docs]</a>    <span class="k">def</span> <span class="nf">clear_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clear all stimulation and recording mecanism</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># extra-cellular stimulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_stim</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">footprints</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_footprinted</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">myelinated_nseg_per_sec</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unmyelinated_nseg</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="c1"># intra-cellular stimulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N_intra</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_position</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_t_start</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_duration</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_amplitude</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_ON</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">## recording mechanism</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">record</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recorder</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_simulated</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="fascicle.attach_extracellular_stimulation"><a class="viewcode-back" href="../../../nrv.nmod.html#nrv.nmod.fascicles.fascicle.attach_extracellular_stimulation">[docs]</a>    <span class="k">def</span> <span class="nf">attach_extracellular_stimulation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stimulation</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        attach a extracellular context of simulation for an axon.</span>

<span class="sd">        Input:</span>
<span class="sd">        ------</span>
<span class="sd">            stimulation  : stimulation object, see Extracellular.stimulation help for more details</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">is_extra_stim</span><span class="p">(</span><span class="n">stimulation</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extra_stim</span> <span class="o">=</span> <span class="n">stimulation</span>
        <span class="c1"># remove everlaping axons</span>
        <span class="k">for</span> <span class="n">electrode</span> <span class="ow">in</span> <span class="n">stimulation</span><span class="o">.</span><span class="n">electrodes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_axons_electrode_overlap</span><span class="p">(</span><span class="n">electrode</span><span class="p">)</span></div>

<div class="viewcode-block" id="fascicle.change_stimulus_from_elecrode"><a class="viewcode-back" href="../../../nrv.nmod.html#nrv.nmod.fascicles.fascicle.change_stimulus_from_elecrode">[docs]</a>    <span class="k">def</span> <span class="nf">change_stimulus_from_elecrode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ID_elec</span><span class="p">,</span> <span class="n">stimulus</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Change the stimulus of the ID_elec electrods</span>
<span class="sd">        </span>
<span class="sd">        Input:</span>
<span class="sd">        ------</span>
<span class="sd">            ID_elec  : int</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_stim</span><span class="o">.</span><span class="n">stimuli</span><span class="p">[</span><span class="n">ID_elec</span><span class="p">]</span> <span class="o">=</span> <span class="n">stimulus</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_stim</span><span class="o">.</span><span class="n">synchronised_stimuli</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_stim</span><span class="o">.</span><span class="n">synchronised</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="fascicle.insert_I_Clamp"><a class="viewcode-back" href="../../../nrv.nmod.html#nrv.nmod.fascicles.fascicle.insert_I_Clamp">[docs]</a>    <span class="k">def</span> <span class="nf">insert_I_Clamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">t_start</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">,</span> <span class="n">ax_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Insert a IC clamp stimulation</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        position    : float</span>
<span class="sd">            relative position over the fascicle. Note that all thin myelinated and myelinated</span>
<span class="sd">            will be stimulated in the nearest node of Ranvier around the clamp specified position</span>
<span class="sd">        t_start     : float</span>
<span class="sd">            starting time, in ms</span>
<span class="sd">        duration    : float</span>
<span class="sd">            duration of the pulse, in ms</span>
<span class="sd">        amplitude   : float</span>
<span class="sd">            amplitude of the pulse (nA)</span>
<span class="sd">        ax_list     : list, array, np.array</span>
<span class="sd">            list of axons to insert the clamp on, if None, all axons are stimulated</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_position</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_t_start</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t_start</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_duration</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_amplitude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">amplitude</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_ON</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N_intra</span> <span class="o">+=</span> <span class="mi">1</span></div>

    <span class="c1">## RECORDING MECHANIMS</span>
<div class="viewcode-block" id="fascicle.attach_extracellular_recorder"><a class="viewcode-back" href="../../../nrv.nmod.html#nrv.nmod.fascicles.fascicle.attach_extracellular_recorder">[docs]</a>    <span class="k">def</span> <span class="nf">attach_extracellular_recorder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rec</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        attach an extracellular recorder to the axon</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rec     : recorder object</span>
<span class="sd">            see Recording.recorder help for more details</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">is_recorder</span><span class="p">(</span><span class="n">rec</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">record</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recorder</span> <span class="o">=</span> <span class="n">rec</span></div>

<div class="viewcode-block" id="fascicle.shut_recorder_down"><a class="viewcode-back" href="../../../nrv.nmod.html#nrv.nmod.fascicles.fascicle.shut_recorder_down">[docs]</a>    <span class="k">def</span> <span class="nf">shut_recorder_down</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shuts down the recorder locally</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">record</span> <span class="o">=</span> <span class="kc">False</span></div>

    <span class="c1">## SIMULATION HANDLING</span>
<div class="viewcode-block" id="fascicle.generate_random_NoR_position"><a class="viewcode-back" href="../../../nrv.nmod.html#nrv.nmod.fascicles.fascicle.generate_random_NoR_position">[docs]</a>    <span class="k">def</span> <span class="nf">generate_random_NoR_position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates radom Node of Ranvier shifts to prevent from axons with the same diamters to be aligned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># also generated for unmyelinated but the meaningless value won&#39;t be used</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NoR_relative_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span><span class="p">))</span></div>

<div class="viewcode-block" id="fascicle.generate_ligned_NoR_position"><a class="viewcode-back" href="../../../nrv.nmod.html#nrv.nmod.fascicles.fascicle.generate_ligned_NoR_position">[docs]</a>    <span class="k">def</span> <span class="nf">generate_ligned_NoR_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates Node of Ranvier shifts to aligned a node of each axon to x postition.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x    : float</span>
<span class="sd">            x axsis value (um) on which node are lined, by default 0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># also generated for unmyelinated but the meaningless value won&#39;t be used</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NoR_relative_position</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_type</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">NoR_relative_position</span> <span class="o">+=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">i</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">node_length</span> <span class="o">=</span> <span class="n">get_MRG_parameters</span><span class="p">(</span><span class="n">d</span><span class="p">)[</span><span class="mi">5</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">NoR_relative_position</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">x</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">%</span> <span class="n">node_length</span> <span class="o">/</span> <span class="n">node_length</span><span class="p">]</span></div>
                <span class="c1"># -0.5 to be at the node of Ranvier center as a node is 1um long</span>

<div class="viewcode-block" id="fascicle.get_electrodes_footprints_on_axons"><a class="viewcode-back" href="../../../nrv.nmod.html#nrv.nmod.fascicles.fascicle.get_electrodes_footprints_on_axons">[docs]</a>    <span class="k">def</span> <span class="nf">get_electrodes_footprints_on_axons</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">myelinated_nseg_per_sec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unmyelinated_nseg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>\
        <span class="n">Unmyelinated_model</span><span class="o">=</span><span class="s1">&#39;Rattay_Aberham&#39;</span><span class="p">,</span> <span class="n">Adelta_model</span><span class="o">=</span><span class="s1">&#39;extended_Gaines&#39;</span><span class="p">,</span> <span class="n">Myelinated_model</span><span class="o">=</span><span class="s1">&#39;MRG&#39;</span><span class="p">,</span>\
        <span class="n">save_ftp_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;electrodes_footprint.ftpt&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get electrodes footprints on each segment of each axon</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        save_ftp_only        :bool</span>
<span class="sd">            if true save result in a .ftpt file</span>
<span class="sd">        filename    :str</span>
<span class="sd">            saving file name and path</span>
<span class="sd">        Unmyelinated_model  : str</span>
<span class="sd">            model for unmyelinated fibers, by default &#39;Rattay_Aberham&#39;</span>
<span class="sd">        Adelta_model        : str</span>
<span class="sd">            model for A-delta thin myelinated fibers, by default&#39;extended_Gaines&#39;</span>
<span class="sd">        Myelinated_model    : str</span>
<span class="sd">            model for myelinated fibers, by default &#39;MRG&#39;</span>
<span class="sd">        myelinated_nseg_per_sec        : int</span>
<span class="sd">            number of segment per section for myelinated axons</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        footprints   : dict</span>
<span class="sd">            Dictionnary composed of axon footprint dictionary, the keys are int value</span>
<span class="sd">            of the corresponding axon ID</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">footprints</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">MCH</span><span class="o">.</span><span class="n">do_master_only_work</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">unmyelinated_nseg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unmyelinated_nseg</span> <span class="o">=</span> <span class="n">unmyelinated_nseg</span>
            <span class="k">if</span> <span class="n">myelinated_nseg_per_sec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">myelinated_nseg_per_sec</span> <span class="o">=</span> <span class="n">myelinated_nseg_per_sec</span>
            <span class="k">if</span> <span class="n">is_FEM_extra_stim</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extra_stim</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">extra_stim</span><span class="o">.</span><span class="n">run_model</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span><span class="p">)):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_type</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">axon</span> <span class="o">=</span> <span class="n">unmyelinated</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axons_y</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_z</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>\
                        <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">Unmyelinated_model</span><span class="p">,</span>\
                        <span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span> <span class="n">freq_min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_min</span><span class="p">,</span> <span class="n">mesh_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh_shape</span><span class="p">,</span>\
                        <span class="n">v_init</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_max</span><span class="p">,</span> <span class="n">d_lambda</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">d_lambda</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">ID</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>\
                        <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span> <span class="n">Nseg_per_sec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unmyelinated_nseg</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">## if myelinated, test the axons_diameter[k],</span>
                    <span class="c1">## if less than Adelta_limit -&gt; A-delta model, else Myelinated</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">Adelta_limit</span><span class="p">:</span>
                        <span class="n">axon</span> <span class="o">=</span> <span class="n">thin_myelinated</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axons_y</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_z</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>\
                            <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">Adelta_model</span><span class="p">,</span>\
                            <span class="n">node_shift</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">NoR_relative_position</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">rec</span><span class="o">=</span><span class="s1">&#39;nodes&#39;</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>\
                            <span class="n">Nseg_per_sec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">myelinated_nseg_per_sec</span><span class="p">,</span> <span class="n">v_init</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">ID</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>\
                            <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">axon</span> <span class="o">=</span> <span class="n">myelinated</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axons_y</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_z</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>\
                            <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">Myelinated_model</span><span class="p">,</span>\
                            <span class="n">node_shift</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">NoR_relative_position</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">rec</span><span class="o">=</span><span class="s1">&#39;nodes&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span>\
                            <span class="n">Nseg_per_sec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">myelinated_nseg_per_sec</span><span class="p">,</span> <span class="n">v_init</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>\
                            <span class="n">ID</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">)</span>
                <span class="n">axon</span><span class="o">.</span><span class="n">attach_extracellular_stimulation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extra_stim</span><span class="p">)</span>
                <span class="n">footprints</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">axon</span><span class="o">.</span><span class="n">get_electrodes_footprints_on_axon</span><span class="p">(</span><span class="n">save_ftp_only</span><span class="o">=</span><span class="n">save_ftp_only</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">save_ftp_only</span><span class="p">:</span>
                <span class="n">json_dump</span><span class="p">(</span><span class="n">footprints</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">sync_Flag</span> <span class="o">=</span> <span class="n">MCH</span><span class="o">.</span><span class="n">send_synchronization_flag</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">footprints</span> <span class="o">=</span> <span class="n">MCH</span><span class="o">.</span><span class="n">master_broadcasts_array_to_all</span><span class="p">(</span><span class="n">footprints</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_footprinted</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">footprints</span></div>


<div class="viewcode-block" id="fascicle.simulate"><a class="viewcode-back" href="../../../nrv.nmod.html#nrv.nmod.fascicles.fascicle.simulate">[docs]</a>    <span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t_sim</span><span class="o">=</span><span class="mf">2e1</span><span class="p">,</span> <span class="n">record_V_mem</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">record_I_mem</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">record_I_ions</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>\
        <span class="n">record_g_mem</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">record_g_ions</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">record_particles</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">loaded_footprints</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>\
        <span class="n">save_V_mem</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">Unmyelinated_model</span><span class="o">=</span><span class="s1">&#39;Rattay_Aberham&#39;</span><span class="p">,</span> \
        <span class="n">Adelta_model</span><span class="o">=</span><span class="s1">&#39;extended_Gaines&#39;</span><span class="p">,</span><span class="n">Myelinated_model</span><span class="o">=</span><span class="s1">&#39;MRG&#39;</span><span class="p">,</span><span class="n">myelinated_nseg_per_sec</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">unmyelinated_nseg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>\
        <span class="n">Adelta_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">PostProc_Filtering</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">postproc_script</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simulates the fascicle using neuron framework. Parallel computing friendly. Does not return</span>
<span class="sd">        results (possibly too large in memory and complex with parallel computing), but instead </span>
<span class="sd">        creates a folder and store fascicle configuration and all axons results.</span>
<span class="sd">        On the fly post processing is possible by specifying an additional script.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        t_sim               : float</span>
<span class="sd">            total simulation time (ms), by default 20 ms</span>
<span class="sd">        record_V_mem        : bool</span>
<span class="sd">            if true, the membrane voltage is recorded, set to True by default</span>
<span class="sd">        record_I_mem        : bool</span>
<span class="sd">            if true, the membrane current is recorded, set to False by default</span>
<span class="sd">        record_I_ions       : bool</span>
<span class="sd">            if true, the ionic currents are recorded, set to False by default</span>
<span class="sd">        record_particules   : bool</span>
<span class="sd">            if true, the marticule states are recorded, set to False by default</span>
<span class="sd">        loaded_footprints          : dict or bool</span>
<span class="sd">            Dictionnary composed of axon footprint dictionary, the keys are int value</span>
<span class="sd">            of the corresponding axon ID. if type is bool, fascicle footprints attribute is used</span>
<span class="sd">            if None, footprins calculated during the simulation, by default None</span>
<span class="sd">        save_V_mem          : bool</span>
<span class="sd">            if true, all membrane voltages values are stored in results whe basic postprocessing is</span>
<span class="sd">            applied. Can be heavy ! False by default</span>
<span class="sd">        save_path           : str</span>
<span class="sd">            name of the folder to store results of the fascicle simulation.</span>
<span class="sd">        Unmyelinated_model  : str</span>
<span class="sd">            model for unmyelinated fibers, by default &#39;Rattay_Aberham&#39;</span>
<span class="sd">        Adelta_model        : str</span>
<span class="sd">            model for A-delta thin myelinated fibers, by default&#39;extended_Gaines&#39;</span>
<span class="sd">        Myelinated_model    : str</span>
<span class="sd">            model for myelinated fibers, by default &#39;MRG&#39;</span>
<span class="sd">        myelinated_seg_per_sec        : int</span>
<span class="sd">            number of segment per section for myelinated axons</span>
<span class="sd">        Adelta_limit        : float</span>
<span class="sd">            limit diameter between A-delta models (thin myelinated) and myelinated models for</span>
<span class="sd">            axons. Overwritte the fascicle limit, if unnecessary, specify None. None by default</span>
<span class="sd">        PostProc_Filtering  : float, list, array, np.array</span>
<span class="sd">            value or iterable values for basic post proc filtering. If None specified, no filtering</span>
<span class="sd">            is performed</span>
<span class="sd">        postproc_script     : str</span>
<span class="sd">            path to a postprocessing file. If specified, the basic post processing is not</span>
<span class="sd">            performed, and all postprocessing have to be handled by user. The specified script</span>
<span class="sd">            can access global and local variables. Can also be key word (&#39;Vmem_plot&#39; or &#39;scarter&#39;) </span>
<span class="sd">            to use script saved in OTF_PP folder, use with caution</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">postproc_script</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">nrv</span> <span class="c1"># not ideal at all but gives direct acces to nrv in the postprocessing script</span>
        <span class="k">if</span> <span class="n">Adelta_limit</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Adelta_limit</span> <span class="ow">and</span> <span class="n">Adelta_limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Adelta_limit</span> <span class="o">=</span> <span class="n">Adelta_limit</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NoR_relative_position</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">generate_random_NoR_position</span><span class="p">()</span>
        <span class="c1">## create folder and save fascicle config</span>
        <span class="n">folder_name</span> <span class="o">=</span> <span class="n">save_path</span> <span class="o">+</span> <span class="s1">&#39;Fascicle_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">MCH</span><span class="o">.</span><span class="n">do_master_only_work</span><span class="p">():</span>
            <span class="n">create_folder</span><span class="p">(</span><span class="n">folder_name</span><span class="p">)</span>
            <span class="n">config_filename</span> <span class="o">=</span> <span class="n">folder_name</span> <span class="o">+</span> <span class="s1">&#39;/00_Fascicle_config.json&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">config_filename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c1"># impose myelinated_nseg_per_sec if footprint are loaded</span>
        <span class="n">loaded_footprints</span> <span class="o">=</span> <span class="n">loaded_footprints</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_footprinted</span>
        <span class="k">if</span> <span class="n">loaded_footprints</span><span class="p">:</span>
            <span class="n">myelinated_nseg_per_sec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">myelinated_nseg_per_sec</span>
        <span class="k">if</span> <span class="n">unmyelinated_nseg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unmyelinated_nseg</span> <span class="o">=</span> <span class="n">unmyelinated_nseg</span>
        <span class="c1">## create ID for all axons</span>
        <span class="n">axons_ID</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span><span class="p">))</span>
        <span class="c1">###### FEM STIMULATION IN PARALLEL: master computes FEM (only one COMSOL licence, other computes axons)####</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_stim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">loaded_footprints</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_analytical_extra_stim</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extra_stim</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">MCH</span><span class="o">.</span><span class="n">is_alone</span><span class="p">():</span>
            <span class="c1"># master solves FEM model</span>
            <span class="k">if</span> <span class="n">MCH</span><span class="o">.</span><span class="n">do_master_only_work</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">extra_stim</span><span class="o">.</span><span class="n">run_model</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1"># synchronize all process</span>
            <span class="n">sync_Flag</span> <span class="o">=</span> <span class="n">MCH</span><span class="o">.</span><span class="n">send_synchronization_flag</span><span class="p">()</span>
            <span class="c1"># split the job</span>
            <span class="n">this_core_mask</span> <span class="o">=</span> <span class="n">MCH</span><span class="o">.</span><span class="n">split_job_from_arrays_to_slaves</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">MCH</span><span class="o">.</span><span class="n">do_master_only_work</span><span class="p">():</span>
                <span class="c1">## Master acts as a server, accepting request to compute external potential</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">this_core_mask</span><span class="p">):</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">MCH</span><span class="o">.</span><span class="n">recieve_data_from_slave</span><span class="p">()</span>
                    <span class="n">this_core_mask</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_stim</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_potentials</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">])</span>
                    <span class="n">back_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;V&#39;</span><span class="p">:</span> <span class="n">V</span><span class="p">}</span>
                    <span class="n">MCH</span><span class="o">.</span><span class="n">send_back_array_to_dest</span><span class="p">(</span><span class="n">back_data</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">## Slaves computes neurons sending requests to the master from (see FEM_stimulation.compute_electrodes_footprints method)</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">this_core_mask</span><span class="p">:</span>
                    <span class="c1">## test axon axons_type[k]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_type</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">axon</span> <span class="o">=</span> <span class="n">unmyelinated</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axons_y</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_z</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>\
                            <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">Unmyelinated_model</span><span class="p">,</span>\
                            <span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span> <span class="n">freq_min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_min</span><span class="p">,</span> <span class="n">mesh_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh_shape</span><span class="p">,</span>\
                            <span class="n">v_init</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_max</span><span class="p">,</span> <span class="n">d_lambda</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">d_lambda</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">ID</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>\
                            <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span> <span class="n">Nseg_per_sec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unmyelinated_nseg</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1">## if myelinated, test the axons_diameter[k],</span>
                        <span class="c1">## if less than Adelta_limit -&gt; A-delta model, else Myelinated</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">Adelta_limit</span><span class="p">:</span>
                            <span class="n">axon</span> <span class="o">=</span> <span class="n">thin_myelinated</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axons_y</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_z</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>\
                                <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">Adelta_model</span><span class="p">,</span>\
                                <span class="n">node_shift</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">NoR_relative_position</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">rec</span><span class="o">=</span><span class="s1">&#39;nodes&#39;</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>\
                                <span class="n">Nseg_per_sec</span><span class="o">=</span><span class="n">myelinated_nseg_per_sec</span><span class="p">,</span> <span class="n">v_init</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">ID</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>\
                                <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">axon</span> <span class="o">=</span> <span class="n">myelinated</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axons_y</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_z</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>\
                                <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">Myelinated_model</span><span class="p">,</span>\
                                <span class="n">node_shift</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">NoR_relative_position</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">rec</span><span class="o">=</span><span class="s1">&#39;nodes&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span>\
                                <span class="n">Nseg_per_sec</span><span class="o">=</span><span class="n">myelinated_nseg_per_sec</span><span class="p">,</span> <span class="n">v_init</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>\
                                <span class="n">ID</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">)</span>
                    <span class="c1">## add extracellular stimulation</span>
                    <span class="n">axon</span><span class="o">.</span><span class="n">attach_extracellular_stimulation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extra_stim</span><span class="p">)</span>
                    <span class="c1">## add recording mechanism</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">record</span><span class="p">:</span>
                        <span class="n">axon</span><span class="o">.</span><span class="n">attach_extracellular_recorder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">recorder</span><span class="p">)</span>
                    <span class="c1"># add intracellular stim</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_intra</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_intra</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">is_iterable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_ON</span><span class="p">[</span><span class="n">j</span><span class="p">]):</span>
                                <span class="c1"># in this case, the stimulation is possibly not for all axons</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_ON</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]:</span>
                                    <span class="c1"># then stimulation should apply, look for the parameters</span>
                                    <span class="c1"># get position</span>
                                    <span class="k">if</span> <span class="n">is_iterable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_position</span><span class="p">[</span><span class="n">j</span><span class="p">]):</span>
                                        <span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_position</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_position</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                                    <span class="c1"># get t_start</span>
                                    <span class="k">if</span> <span class="n">is_iterable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_t_start</span><span class="p">[</span><span class="n">j</span><span class="p">]):</span>
                                        <span class="n">t_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_t_start</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">t_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_t_start</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                                    <span class="c1"># get duration</span>
                                    <span class="k">if</span> <span class="n">is_iterable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_duration</span><span class="p">[</span><span class="n">j</span><span class="p">]):</span>
                                        <span class="n">duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_duration</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_duration</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                                    <span class="c1"># get amplitude</span>
                                    <span class="k">if</span> <span class="n">is_iterable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_amplitude</span><span class="p">[</span><span class="n">j</span><span class="p">]):</span>
                                        <span class="n">amplitude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_amplitude</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">amplitude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_amplitude</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                                    <span class="c1"># APPLY INTRA CELLULAR STIMULATION</span>
                                    <span class="n">axon</span><span class="o">.</span><span class="n">insert_I_Clamp</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">t_start</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># in this case , stimulate all axons</span>
                                <span class="k">if</span> <span class="n">is_iterable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_position</span><span class="p">[</span><span class="n">j</span><span class="p">]):</span>
                                    <span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_position</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_position</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                                <span class="c1"># get t_start</span>
                                <span class="k">if</span> <span class="n">is_iterable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_t_start</span><span class="p">[</span><span class="n">j</span><span class="p">]):</span>
                                    <span class="n">t_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_t_start</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">t_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_t_start</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                                <span class="c1"># get duration</span>
                                <span class="k">if</span> <span class="n">is_iterable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_duration</span><span class="p">[</span><span class="n">j</span><span class="p">]):</span>
                                    <span class="n">duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_duration</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_duration</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                                <span class="c1"># get amplitude</span>
                                <span class="k">if</span> <span class="n">is_iterable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_amplitude</span><span class="p">[</span><span class="n">j</span><span class="p">]):</span>
                                    <span class="n">amplitude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_amplitude</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">amplitude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_amplitude</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                                <span class="c1"># APPLY INTRA CELLULAR STIMULATION</span>
                                <span class="n">axon</span><span class="o">.</span><span class="n">insert_I_Clamp</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">t_start</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">)</span>
                    <span class="c1">## perform simulation</span>
                    <span class="k">if</span> <span class="n">loaded_footprints</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
                        <span class="n">axon_ftpt</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">elif</span> <span class="n">loaded_footprints</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                        <span class="n">axon_ftpt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">footprints</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">axon_ftpt</span> <span class="o">=</span> <span class="n">loaded_footprints</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="n">sim_results</span> <span class="o">=</span> <span class="n">axon</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">t_sim</span><span class="o">=</span><span class="n">t_sim</span><span class="p">,</span> <span class="n">record_V_mem</span><span class="o">=</span><span class="n">record_V_mem</span><span class="p">,</span>\
                        <span class="n">record_I_mem</span><span class="o">=</span><span class="n">record_I_mem</span><span class="p">,</span> <span class="n">record_I_ions</span><span class="o">=</span><span class="n">record_I_ions</span><span class="p">,</span>\
                        <span class="n">record_g_mem</span><span class="o">=</span><span class="n">record_g_mem</span><span class="p">,</span> <span class="n">record_g_ions</span><span class="o">=</span><span class="n">record_g_ions</span><span class="p">,</span> \
                        <span class="n">record_particles</span><span class="o">=</span><span class="n">record_particles</span><span class="p">,</span> <span class="n">loaded_footprints</span><span class="o">=</span><span class="n">axon_ftpt</span><span class="p">)</span>
                    <span class="k">del</span> <span class="n">axon</span>
                    <span class="c1">## postprocessing and data reduction</span>
                    <span class="k">if</span> <span class="n">postproc_script</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">OTF_PP_library</span><span class="p">:</span>
                        <span class="n">postproc_script</span> <span class="o">=</span> <span class="n">OTF_PP_path</span><span class="o">+</span><span class="n">postproc_script</span>
                    <span class="k">elif</span> <span class="n">postproc_script</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;.py&#39;</span> <span class="ow">in</span> <span class="n">OTF_PP_library</span><span class="p">:</span>
                        <span class="n">postproc_script</span> <span class="o">=</span> <span class="n">OTF_PP_path</span><span class="o">+</span><span class="n">postproc_script</span><span class="o">+</span><span class="s1">&#39;.py&#39;</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">postproc_script</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">postproc_script</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
                        <span class="n">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="nb">locals</span><span class="p">())</span>
                    <span class="c1">## store results</span>
                    <span class="n">ax_fname</span> <span class="o">=</span> <span class="s1">&#39;sim_axon_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.json&#39;</span>
                    <span class="n">save_axon_results_as_json</span><span class="p">(</span><span class="n">sim_results</span><span class="p">,</span> <span class="n">folder_name</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">ax_fname</span><span class="p">)</span>
                <span class="c1"># sum up all recorded extracellular potential if applicable</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">record</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">recorder</span><span class="o">.</span><span class="n">gather_all_recordings</span><span class="p">()</span>
        <span class="c1">###### NO STIM OR ANALYTICAL STIM: all in parallel, OR FEM STIM NO PARALLEL</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">## split the job between Cores/Computation nodes</span>
            <span class="n">this_core_mask</span> <span class="o">=</span> <span class="n">MCH</span><span class="o">.</span><span class="n">split_job_from_arrays</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span><span class="p">))</span>
            <span class="c1">## perform simulations</span>
            <span class="k">if</span> <span class="n">MCH</span><span class="o">.</span><span class="n">is_alone</span><span class="p">()</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Simulating axons in fascicle &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ID</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">this_core_mask</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">MCH</span><span class="o">.</span><span class="n">is_alone</span><span class="p">()</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> Axon &#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1">## test axon axons_type[k]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_type</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">axon</span> <span class="o">=</span> <span class="n">unmyelinated</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axons_y</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_z</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>\
                        <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">Unmyelinated_model</span><span class="p">,</span>\
                        <span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span> <span class="n">freq_min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_min</span><span class="p">,</span> <span class="n">mesh_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh_shape</span><span class="p">,</span>\
                        <span class="n">v_init</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_max</span><span class="p">,</span> <span class="n">d_lambda</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">d_lambda</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">ID</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>\
                        <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span> <span class="n">Nseg_per_sec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unmyelinated_nseg</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">## if myelinated, test the axons_diameter[k],</span>
                    <span class="c1">## if less than Adelta_limit -&gt; A-delta model, else Myelinated</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">Adelta_limit</span><span class="p">:</span>
                        <span class="n">axon</span> <span class="o">=</span> <span class="n">thin_myelinated</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axons_y</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_z</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>\
                            <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">Adelta_model</span><span class="p">,</span>\
                            <span class="n">node_shift</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">NoR_relative_position</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">rec</span><span class="o">=</span><span class="s1">&#39;nodes&#39;</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>\
                            <span class="n">Nseg_per_sec</span><span class="o">=</span><span class="n">myelinated_nseg_per_sec</span><span class="p">,</span> <span class="n">v_init</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">ID</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>\
                            <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">axon</span> <span class="o">=</span> <span class="n">myelinated</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axons_y</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">axons_z</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>\
                            <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axons_diameter</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">Myelinated_model</span><span class="p">,</span>\
                            <span class="n">node_shift</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">NoR_relative_position</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">rec</span><span class="o">=</span><span class="s1">&#39;nodes&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span>\
                            <span class="n">Nseg_per_sec</span><span class="o">=</span><span class="n">myelinated_nseg_per_sec</span><span class="p">,</span> <span class="n">v_init</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>\
                            <span class="n">ID</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">)</span>
                <span class="c1">## add extracellular stimulation</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_stim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">axon</span><span class="o">.</span><span class="n">attach_extracellular_stimulation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extra_stim</span><span class="p">)</span>
                <span class="c1">## add recording mechanism</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">record</span><span class="p">:</span>
                    <span class="n">axon</span><span class="o">.</span><span class="n">attach_extracellular_recorder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">recorder</span><span class="p">)</span>
                <span class="c1">## add intracellular stim</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_intra</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_intra</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">is_iterable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_ON</span><span class="p">[</span><span class="n">j</span><span class="p">]):</span>
                            <span class="c1"># in this case, the stimulation is possibly not for all axons</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_ON</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]:</span>
                                <span class="c1"># then stimulation should apply, look for the parameters</span>
                                <span class="c1"># get position</span>
                                <span class="k">if</span> <span class="n">is_iterable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_position</span><span class="p">[</span><span class="n">j</span><span class="p">]):</span>
                                    <span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_position</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_position</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                                <span class="c1"># get t_start</span>
                                <span class="k">if</span> <span class="n">is_iterable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_t_start</span><span class="p">[</span><span class="n">j</span><span class="p">]):</span>
                                    <span class="n">t_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_t_start</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">t_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_t_start</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                                <span class="c1"># get duration</span>
                                <span class="k">if</span> <span class="n">is_iterable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_duration</span><span class="p">[</span><span class="n">j</span><span class="p">]):</span>
                                    <span class="n">duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_duration</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_duration</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                                <span class="c1"># get amplitude</span>
                                <span class="k">if</span> <span class="n">is_iterable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_amplitude</span><span class="p">[</span><span class="n">j</span><span class="p">]):</span>
                                    <span class="n">amplitude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_amplitude</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">amplitude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_amplitude</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                                <span class="c1"># APPLY INTRA CELLULAR STIMULATION</span>
                                <span class="n">axon</span><span class="o">.</span><span class="n">insert_I_Clamp</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">t_start</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># in this case , stimulate all axons</span>
                            <span class="k">if</span> <span class="n">is_iterable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_position</span><span class="p">[</span><span class="n">j</span><span class="p">]):</span>
                                <span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_position</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_position</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                            <span class="c1"># get t_start</span>
                            <span class="k">if</span> <span class="n">is_iterable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_t_start</span><span class="p">[</span><span class="n">j</span><span class="p">]):</span>
                                <span class="n">t_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_t_start</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">t_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_t_start</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                            <span class="c1"># get duration</span>
                            <span class="k">if</span> <span class="n">is_iterable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_duration</span><span class="p">[</span><span class="n">j</span><span class="p">]):</span>
                                <span class="n">duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_duration</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_duration</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                            <span class="c1"># get amplitude</span>
                            <span class="k">if</span> <span class="n">is_iterable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_amplitude</span><span class="p">[</span><span class="n">j</span><span class="p">]):</span>
                                <span class="n">amplitude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_amplitude</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">amplitude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intra_stim_amplitude</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                            <span class="c1"># APPLY INTRA CELLULAR STIMULATION</span>
                            <span class="n">axon</span><span class="o">.</span><span class="n">insert_I_Clamp</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">t_start</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">)</span>
                <span class="c1">## perform simulation</span>
                <span class="k">if</span> <span class="n">loaded_footprints</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
                    <span class="n">axon_ftpt</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">elif</span> <span class="n">loaded_footprints</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                    <span class="n">axon_ftpt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">footprints</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">axon_ftpt</span> <span class="o">=</span> <span class="n">loaded_footprints</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

                <span class="n">sim_results</span> <span class="o">=</span> <span class="n">axon</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">t_sim</span><span class="o">=</span><span class="n">t_sim</span><span class="p">,</span> <span class="n">record_V_mem</span><span class="o">=</span><span class="n">record_V_mem</span><span class="p">,</span>\
                    <span class="n">record_I_mem</span><span class="o">=</span><span class="n">record_I_mem</span><span class="p">,</span> <span class="n">record_I_ions</span><span class="o">=</span><span class="n">record_I_ions</span><span class="p">,</span>\
                    <span class="n">record_g_mem</span><span class="o">=</span><span class="n">record_g_mem</span><span class="p">,</span> <span class="n">record_g_ions</span><span class="o">=</span><span class="n">record_g_ions</span><span class="p">,</span> \
                    <span class="n">record_particles</span><span class="o">=</span><span class="n">record_particles</span><span class="p">,</span> <span class="n">loaded_footprints</span><span class="o">=</span><span class="n">axon_ftpt</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">axon</span>
                <span class="c1">## postprocessing and data reduction</span>
                <span class="k">if</span> <span class="n">postproc_script</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">OTF_PP_library</span><span class="p">:</span>
                    <span class="n">postproc_script</span> <span class="o">=</span> <span class="n">OTF_PP_path</span><span class="o">+</span><span class="n">postproc_script</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">postproc_script</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;.py&#39;</span> <span class="ow">in</span> <span class="n">OTF_PP_library</span><span class="p">:</span>
                    <span class="n">postproc_script</span> <span class="o">=</span> <span class="n">OTF_PP_path</span><span class="o">+</span><span class="n">postproc_script</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;.py&#39;</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">postproc_script</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">postproc_script</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
                    <span class="n">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="nb">locals</span><span class="p">())</span>
                <span class="c1">## store results</span>
                <span class="n">ax_fname</span> <span class="o">=</span> <span class="s1">&#39;sim_axon_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.json&#39;</span>
                <span class="n">save_axon_results_as_json</span><span class="p">(</span><span class="n">sim_results</span><span class="p">,</span> <span class="n">folder_name</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">ax_fname</span><span class="p">)</span>
            <span class="c1"># sum up all recorded extracellular potential if applicable</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">record</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">recorder</span><span class="o">.</span><span class="n">gather_all_recordings</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">MCH</span><span class="o">.</span><span class="n">is_alone</span><span class="p">()</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">pass_info</span><span class="p">(</span><span class="s1">&#39;... Simulation done&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_simulated</span> <span class="o">=</span> <span class="kc">True</span></div></div>
</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            Made with 
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/scripts/furo.js"></script>
    </body>
</html>